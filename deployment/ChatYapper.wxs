<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  
  <!-- Product Definition -->
  <Package Name="Chat Yapper"
           Manufacturer="Pladis Development"
           Version="1.1.0"
           UpgradeCode="A1B2C3D4-E5F6-7890-ABCD-EF1234567890"
           Language="1033"
           Compressed="yes"
           InstallerVersion="500">
    
    <SummaryInformation Description="Chat Yapper - Twitch and YouTube Chat TTS Application"
                        Comments="Converts chat messages to speech"
                        Manufacturer="Pladis Development"
                        Keywords="chat,tts,twitch,youtube" />

    <!-- Major Upgrade - handles upgrades and prevents downgrades -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed."
                  Schedule="afterInstallInitialize" />

    <!-- Media/Compression -->
    <Media Id="1" Cabinet="ChatYapper.cab" EmbedCab="yes" />

    <!-- Icon for Add/Remove Programs and shortcuts -->
    <!-- First try to use icon from assets, fallback to exe icon -->
    <Icon Id="AppIcon" SourceFile="$(var.SourceDir)\..\assets\icon.ico" />
    <Property Id="ARPPRODUCTICON" Value="AppIcon" />
    
    <!-- Add/Remove Programs entries -->
    <Property Id="ARPHELPLINK" Value="https://github.com/pladisdev/chat-yapper" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/pladisdev/chat-yapper" />
    <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />
    
    <!-- Properties for user choices -->
    <Property Id="DESKTOP_SHORTCUT" Value="1" />
    <Property Id="STARTMENU_SHORTCUT" Value="1" />
    <Property Id="LAUNCH_APP" Value="1" />
    
    <!-- Directory Structure -->
    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="INSTALLFOLDER" Name="Chat Yapper">
        <Directory Id="LOGSFOLDER" Name="logs" />
      </Directory>
    </StandardDirectory>
    
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="Chat Yapper" />
    </StandardDirectory>
    
    <StandardDirectory Id="DesktopFolder" />

    <!-- Components -->
    <ComponentGroup Id="ProductComponents">
      <!-- Main Executable -->
      <Component Id="MainExecutable" Directory="INSTALLFOLDER" Guid="B2C3D4E5-F6A7-8901-BCDE-F12345678901">
        <File Id="ChatYapperExe" 
              Source="$(var.SourceDir)\ChatYapper.exe" 
              KeyPath="yes"
              Checksum="yes">
          <!-- File Association (optional - can be removed if not needed) -->
          <Shortcut Id="ExeStartMenuShortcut"
                    Directory="ApplicationProgramsFolder"
                    Name="Chat Yapper"
                    Description="Launch Chat Yapper TTS Application"
                    WorkingDirectory="INSTALLFOLDER"
                    Icon="AppIcon"
                    Advertise="yes" />
        </File>
        
        <!-- Registry entry for uninstall -->
        <RegistryValue Root="HKCU" 
                      Key="Software\PladisDevelopment\ChatYapper" 
                      Name="installed" 
                      Type="integer" 
                      Value="1" 
                      KeyPath="no" />
      </Component>
      
      <!-- Logs Folder -->
      <Component Id="LogsFolder" Directory="LOGSFOLDER" Guid="C3D4E5F6-A7B8-9012-CDEF-123456789012">
        <CreateFolder>
          <Permission User="Users" GenericAll="yes" />
        </CreateFolder>
        <RemoveFolder Id="RemoveLogsFolder" On="uninstall" />
        <RegistryValue Root="HKCU" 
                      Key="Software\PladisDevelopment\ChatYapper" 
                      Name="LogsFolderCreated" 
                      Type="integer" 
                      Value="1" 
                      KeyPath="yes" />
      </Component>
      
      <!-- Desktop Shortcut (Conditional) -->
      <Component Id="DesktopShortcut" Directory="DesktopFolder" Guid="D4E5F6A7-B8C9-0123-DEF0-234567890123" Condition="DESKTOP_SHORTCUT = 1">
        <Shortcut Id="DesktopShortcut"
                  Name="Chat Yapper"
                  Description="Launch Chat Yapper TTS Application"
                  Target="[INSTALLFOLDER]ChatYapper.exe"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="AppIcon" />
        <RegistryValue Root="HKCU" 
                      Key="Software\PladisDevelopment\ChatYapper" 
                      Name="DesktopShortcut" 
                      Type="integer" 
                      Value="1" 
                      KeyPath="yes" />
        <RemoveFolder Id="RemoveDesktopFolder" On="uninstall" />
      </Component>
    </ComponentGroup>

    <!-- Feature Definition -->
    <Feature Id="ProductFeature" 
             Title="Chat Yapper" 
             Description="Chat Yapper TTS Application"
             Level="1"
             ConfigurableDirectory="INSTALLFOLDER"
             AllowAbsent="no"
             Display="expand">
      <ComponentGroupRef Id="ProductComponents" />
    </Feature>

    <!-- Custom Actions -->
    <!-- Launch application after install - triggered from ExitDialog -->
    <CustomAction Id="LaunchApplication"
                  Directory="INSTALLFOLDER"
                  ExeCommand="[INSTALLFOLDER]ChatYapper.exe"
                  Impersonate="yes"
                  Return="asyncNoWait" />

    <!-- UI Configuration -->
    <UI>
      <!-- Reference standard WixUI_InstallDir dialogs -->
      <DialogRef Id="BrowseDlg" />
      <DialogRef Id="DiskCostDlg" />
      <DialogRef Id="ErrorDlg" />
      <DialogRef Id="FatalError" />
      <DialogRef Id="FilesInUse" />
      <DialogRef Id="MsiRMFilesInUse" />
      <DialogRef Id="PrepareDlg" />
      <DialogRef Id="ProgressDlg" />
      <DialogRef Id="ResumeDlg" />
      <DialogRef Id="UserExit" />
      <DialogRef Id="WelcomeDlg" />
      <DialogRef Id="LicenseAgreementDlg" />
      <DialogRef Id="InstallDirDlg" />
      <DialogRef Id="VerifyReadyDlg" />
      <DialogRef Id="MaintenanceWelcomeDlg" />
      <DialogRef Id="MaintenanceTypeDlg" />
      <DialogRef Id="ExitDialog" />
      
      <!-- Set the install directory property -->
      <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
      
      <!-- Custom Dialog for Shortcuts and Launch Options -->
      <Dialog Id="ShortcutsDialog" 
              Width="370" 
              Height="270" 
              Title="[ProductName] Setup">
        
        <Control Id="Title" 
                 Type="Text" 
                 X="15" 
                 Y="6" 
                 Width="200" 
                 Height="15" 
                 Transparent="yes" 
                 NoPrefix="yes" 
                 Text="{\WixUI_Font_Title}Shortcut Options" />
        
        <Control Id="Description" 
                 Type="Text" 
                 X="25" 
                 Y="23" 
                 Width="280" 
                 Height="15" 
                 Transparent="yes" 
                 NoPrefix="yes" 
                 Text="Select your preferences for shortcuts and launch:" />
        
        <Control Id="BannerBitmap" 
                 Type="Bitmap" 
                 X="0" 
                 Y="0" 
                 Width="370" 
                 Height="44" 
                 TabSkip="no" 
                 Text="!(loc.InstallDirDlgBannerBitmap)" />
        
        <Control Id="BannerLine" 
                 Type="Line" 
                 X="0" 
                 Y="44" 
                 Width="370" 
                 Height="0" />
        
        <Control Id="BottomLine" 
                 Type="Line" 
                 X="0" 
                 Y="234" 
                 Width="370" 
                 Height="0" />
        
        <!-- Start Menu Shortcut Info -->
        <Control Id="StartMenuInfo" 
                 Type="Text" 
                 X="20" 
                 Y="60" 
                 Width="290" 
                 Height="17" 
                 Text="A Start Menu shortcut will be created" 
                 Transparent="yes" />
        
        <!-- Desktop Shortcut Checkbox -->
        <Control Id="DesktopShortcutCheckbox" 
                 Type="CheckBox" 
                 X="20" 
                 Y="85" 
                 Width="290" 
                 Height="17" 
                 Property="DESKTOP_SHORTCUT" 
                 CheckBoxValue="1" 
                 Text="Create a &amp;desktop shortcut" />
        
        <!-- Launch App Checkbox -->
        <Control Id="LaunchAppCheckbox" 
                 Type="CheckBox" 
                 X="20" 
                 Y="110" 
                 Width="290" 
                 Height="17" 
                 Property="LAUNCH_APP" 
                 CheckBoxValue="1" 
                 Text="&amp;Launch Chat Yapper after installation" />
        
        <!-- Navigation Buttons -->
        <Control Id="Back" 
                 Type="PushButton" 
                 X="180" 
                 Y="243" 
                 Width="56" 
                 Height="17" 
                 Text="!(loc.WixUIBack)">
          <Publish Event="NewDialog" Value="InstallDirDlg" />
        </Control>
        
        <Control Id="Next" 
                 Type="PushButton" 
                 X="236" 
                 Y="243" 
                 Width="56" 
                 Height="17" 
                 Default="yes" 
                 Text="!(loc.WixUINext)">
          <Publish Event="NewDialog" Value="VerifyReadyDlg" />
        </Control>
        
        <Control Id="Cancel" 
                 Type="PushButton" 
                 X="304" 
                 Y="243" 
                 Width="56" 
                 Height="17" 
                 Cancel="yes" 
                 Text="!(loc.WixUICancel)">
          <Publish Event="SpawnDialog" Value="CancelDlg" />
        </Control>
      </Dialog>

      <!-- Customize ExitDialog to launch app before closing -->
      <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchApplication" Order="1" Condition="LAUNCH_APP = 1 AND NOT Installed" />
      <Publish Dialog="ExitDialog" Control="Finish" Event="EndDialog" Value="Return" Order="2" />

      <!-- Dialog sequence for WixUI_InstallDir with custom ShortcutsDialog inserted -->
      
      <!-- WelcomeDlg -->
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="LicenseAgreementDlg" />
      
      <!-- LicenseAgreementDlg -->
      <Publish Dialog="LicenseAgreementDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" />
      <Publish Dialog="LicenseAgreementDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" />
      
      <!-- InstallDirDlg - Modified to go to ShortcutsDialog -->
      <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="LicenseAgreementDlg" />
      <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="ShortcutsDialog" />
      <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Property="_BrowseProperty" Value="[WIXUI_INSTALLDIR]" />
      <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Event="SpawnDialog" Value="BrowseDlg" />
      
      <!-- VerifyReadyDlg -->
      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="ShortcutsDialog" />
      
      <!-- Maintenance dialogs -->
      <Publish Dialog="MaintenanceWelcomeDlg" Control="Next" Event="NewDialog" Value="MaintenanceTypeDlg" />
      <Publish Dialog="MaintenanceTypeDlg" Control="RepairButton" Event="NewDialog" Value="VerifyReadyDlg" />
      <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="VerifyReadyDlg" />
      <Publish Dialog="MaintenanceTypeDlg" Control="Back" Event="NewDialog" Value="MaintenanceWelcomeDlg" />
      
    </UI>
    
    <!-- WiX Variables for UI Customization -->
    <WixVariable Id="WixUILicenseRtf" Value="LICENSE.rtf" />
    <WixVariable Id="WixUICostingPopupOptOut" Value="1" />
    
    <!-- Custom Banner and Dialog Images with logo -->
    <!-- Banner: 493x58 pixels (shown on most dialog pages) -->
    <!-- Dialog: 493x312 pixels (shown on welcome and completion pages) -->
    <WixVariable Id="WixUIBannerBmp" Value="banner.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="dialog.bmp" />
  </Package>
</Wix>
